# RNG Fairness Commit/Reveal Guide

## Table of Contents
- [1. Обзор](#1-обзор)
- [2. Термины и формулы](#2-термины-и-формулы)
- [3. Публичные ручки и curl-примеры](#3-публичные-ручки-и-curl-примеры)
- [4. Commit → Reveal → Verify](#4-commit--reveal--verify)
- [5. Хранилище состояний](#5-хранилище-состояний)
- [6. Переменные окружения](#6-переменные-окружения)
- [7. Операционные заметки](#7-операционные-заметки)

## 1. Обзор
- RNG использует классическую схему **commit–reveal** для доказуемой честности ежедневных розыгрышей.
- На каждый день UTC сервис заранее публикует SHA-256 хэш закрытого `serverSeed`. Пользователь может проверить, что результат розыгрыша совпадает с этим коммитом после раскрытия сидов.
- Публичные ручки доступны без авторизации и не содержат чувствительных данных. Раскрытие `serverSeed` возможно только для прошлых дней.

## 2. Термины и формулы
- `fairnessKey` — общий секрет (32 байта в hex), задаётся через `FAIRNESS_KEY`. Он **не раскрывается** публично.
- `serverSeed(day)` — `HMAC-SHA256(fairnessKey, ISO_LOCAL_DATE(day))`. Для 2024-05-12 сообщение равно строке `"2024-05-12"` в UTF-8.
- `serverSeedHash(day)` — `SHA256(serverSeed(day))` в hex. Это значение публикуется в `/fairness/today` и сохраняется в коммитах.
- `clientSeed(userId, nonce, caseId)` — конкатенация `"<userId>|<nonce>|<caseId>|v1"`.
- `rollBytes` — `HMAC-SHA256(serverSeed(day), clientSeed(...))`.
- `ppm` (parts per million) — конвертация первых 8 байт `rollBytes` в беззнаковое 64-битное число `R`, далее `ppm = floor(R * 1_000_000 / 2^64)`.
- `rollHex` — hex-представление полного `rollBytes`.
- `receipt` — структура, которую возвращает `/internal` розыгрыш: дата, хэш коммита, клиентский сид, `rollHex` и `ppm`.

## 3. Публичные ручки и curl-примеры
Во всех примерах замените `https://example.com` на базовый публичный URL сервиса.

### 3.1 Получить текущий коммит
```bash
curl "https://example.com/fairness/today"
```
Пример ответа:
```json
{
  "dayUtc": "2024-05-12",
  "serverSeedHash": "ef3c...d09"
}
```

### 3.2 Раскрыть сид прошлого дня
```bash
curl "https://example.com/fairness/reveal/2024-05-11"
```
Успешный ответ содержит `serverSeed` в hex вместе с временными метками коммита и раскрытия. Для текущей даты вернёт `400 reveal_not_available`.

### 3.3 Проверить результат
```bash
curl -X POST "https://example.com/fairness/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "dayUtc": "2024-05-11",
    "serverSeed": "<SERVER_SEED_HEX>",
    "userId": 123456789,
    "nonce": "spin-42",
    "caseId": "daily_case"
  }'
```
Ответ `200 OK` с `valid=true` содержит рассчитанные `ppm` и `rollHex`, если `serverSeed` совпадает с опубликованным хэшем. Иначе сервис вернёт:
- `404 commit_not_found`, если коммит за день отсутствует;
- `400 invalid_server_seed`, если сид пустой или не hex;
- `400 server_seed_mismatch`, если хэш не совпадает.

## 4. Commit → Reveal → Verify
1. **Commit (ежедневно, UTC):** `RngService.ensureTodayCommit()` вызывается лениво при первом обращении к `/fairness/today` или при старте розыгрыша. В хранилище фиксируется `RngCommitPending` с полями `dayUtc`, `serverSeedHash`, `committedAt`.
2. **Reveal (только прошлые дни):** `/fairness/reveal/{day}` вычисляет `serverSeed` и переводит состояние в `RngCommitRevealed` (добавляется `serverSeed` и `revealedAt`). Попытка раскрыть будущий/текущий день возвращает `400`.
3. **Verify (клиентский контроль):** `/fairness/verify` сверяет предоставленный `serverSeed` с сохранённым `serverSeedHash` и пересчитывает бросок. Возвращаемые `ppm` и `rollHex` должны совпасть с теми, что видели игрок и бэкенд при розыгрыше.
4. **TTL:** Коммиты и розыгрыши автоматически удаляются спустя 30 дней (`RNG_STORE_DEFAULT_TTL`), вне зависимости от режима хранения.

## 5. Хранилище состояний
Доступны два режима, задаются переменной `RNG_STORAGE`:

### 5.1 `memory` (по умолчанию)
- Используется `InMemoryRngStore`. Данные держатся в оперативной памяти процесса.
- При рестарте сервиса история коммитов и розыгрышей теряется (кроме тех, что успели попасть в другое постоянное хранилище).

### 5.2 `file`
- Активируется при `RNG_STORAGE=file`.
- Директория берётся из `RNG_DATA_DIR` или `./data` по умолчанию.
- Файлы:
  - `rng_commits.json` — снапшот всех актуальных `RngCommitState` (pending/revealed) в JSON с дискриминатором `type`.
  - `rng_draws.ndjson` — append-only журнал результатов розыгрышей в NDJSON (по строке на запись).
- Запись коммита выполняется атомарным `move`, чтобы избежать частично записанных файлов. Журнал розыгрышей пополняется в режиме append.
- При старте сервис загружает данные, чистит устаревшие записи (старше 30 дней) и затем продолжает работу как обычный in-memory store.

Переключение между режимами требует рестарта приложения. При первом запуске в файловом режиме директория создаётся автоматически.

## 6. Переменные окружения
| Key | Обязательно | По умолчанию | Назначение |
| --- | --- | --- | --- |
| `FAIRNESS_KEY` | да | — | Hex-строка (длина 64 символа) для генерации `serverSeed`. Храните в секретах. |
| `RNG_STORAGE` | нет | `memory` | Выбор хранилища: `memory` или `file`. Любое другое значение приведёт к ошибке запуска. |
| `RNG_DATA_DIR` | нет | `./data` | Путь для файлового хранилища. Имеет смысл только при `RNG_STORAGE=file`. |
| `ADMIN_TOKEN` | нет | — | Нужен для внутренних ручек `/internal/rng/*` (принудительный commit/reveal). Без токена админ-маршруты не поднимаются. |

## 7. Операционные заметки
- Публичные ручки `/fairness/*` не требуют авторизации, но логируют Call ID и результат; чувствительных данных в логах нет.
- Для инцидентов с пропущенным коммитом используйте `POST /internal/rng/commit-today` (c заголовком `X-Admin-Token`). Он безопасно пересоздаст хэш текущего дня.
- Для ручного раскрытия (например, при задержке фонового процесса) доступен `POST /internal/rng/reveal?day=YYYY-MM-DD`.
- Мониторинг: метрики `rng_commit_total`, `rng_reveal_total`, `rng_draw_total`, `rng_draw_idempotent_total`, `rng_draw_fail_total` публикуются через Micrometer.
- Не публикуйте `FAIRNESS_KEY` и сырые `serverSeed` до завершения дня: раскрытие раньше времени делает розыгрыши предсказуемыми.
